#!/usr/bin/python2
from meocloud_gui.application import Application
import gettext
import locale
import os
import os.path
import filecmp

def init_localization():
    '''prepare l10n'''
    locale.setlocale(locale.LC_ALL, '')
    loc = locale.getlocale()
    filename = "mo/%s.mo" % locale.getlocale()[0][0:2]
    path = os.path.join(os.path.dirname(os.path.realpath(__file__)), filename)

    try:
        trans = gettext.GNUTranslations(open(path, "rb"))
    except IOError:
        trans = gettext.NullTranslations()

    trans.install()


if __name__ == "__main__":
    nautilus_py = os.path.join(os.path.dirname(os.path.realpath(__file__)),
                               "meocloud_nautilus/meocloud-nautilus.py")
    nautilus_dir = os.path.join(os.path.expanduser('~'),
                                '.local/share/nautilus-python/extensions')
    nautilus_dst = os.path.join(nautilus_dir, "meocloud-nautilus.py")

    if not os.path.exists(nautilus_dir):
        os.makedirs(nautilus_dir)

    if os.path.isfile(nautilus_dst):
        if not filecmp.cmp(nautilus_py, nautilus_dst):
            os.remove(nautilus_dst)
            os.symlink(nautilus_py, nautilus_dst)
    else:
        os.symlink(nautilus_py, nautilus_dst)

    init_localization()
    app = Application()
    app.run(None)
